:sourcesdir: ../../../../../source

[[custom_action_types]]
===== Собственные типы действий
--
В проекте можно создать собственные типы действий или переопределить существующие стандартные типы.

Предположим, что вы хотите создать действие, которое бы показывало имя экземпляра текущей сущности, выбранной в таблице, и использовать это действие в различных экранах, указывая только его тип. Чтобы это сделать, необходимо выполнить следующие шаги:

. Создайте для действия отдельный класс с аннотацией `@ActionType`, в которой укажите желаемое имя типа:
+
[source, java]
----
include::{sourcesdir}/gui/std_actions/std_actions_2.java[]
----

. В файле `web-spring.xml` добавьте элемент `<gui:actions>`, и в его атрибуте `base-packages` укажите пакет, в котором нужно искать ваши аннотированные действия:
+
[source, xml]
----
include::{sourcesdir}/gui/std_actions/std_actions_2_1.xml[]
----

. Теперь вы можете использовать действие в дескрипторах экрана, просто указывая его тип:
+
[source, xml]
----
include::{sourcesdir}/gui/std_actions/std_actions_2_2.xml[]
----

[TIP]
====
Если вы хотите переопределить существующий тип действия, просто зарегистрируйте свое новое действие с таким же типом.
====
--

[[custom_action_types_metadata]]
Поддержка в CUBA Studio и редактируемые свойства для собственных действий::
--
Собственные типы действий, реализованные в вашем проекте, могут быть встроены в интерфейс дизайнера экранов CUBA Studio. Дизайнер экранов предоставляет следующую поддержку для собственных типов действий:

* Возможность выбрать тип действия в списке стандартных действий во время добавления нового действия в экран из палитры или при выполнении *+Add* -> *Action* в таблице.
* Быстрая навигация из места использования действия к классу действия по нажатию *Ctrl + B* или Ctrl-клику мыши, когда курсор находится на типе действия в дескрипторе экрана (например на атрибуте `showSelected` в XML-фрагменте `<action id="sel" type="showSelected">`).
* Редактирование определенных пользователем свойств действия в панели *Component Inspector*.
* Генерация обработчиков событий и делегирующих методов, объявленных в классе действия для кастомизации его логики.
* Поддержка параметризации генерик-типом. Генерик-тип определяется как класс сущности, используемый в таблице (компонент-владелец действия).

Аннотация `@com.haulmont.cuba.gui.meta.StudioAction` используется для пометки собственного класса действия, содержащего дополнительные свойства, определенные пользователем. Собственные действия нужно помечать этой аннотацией, однако в данный момент Studio не использует дополнительных атрибутов аннотации `@StudioAction`.

Аннотация `@com.haulmont.cuba.gui.meta.StudioPropertiesItem` используется, чтобы пометить setter-метод свойства действия как редактируемое свойство. Такие свойства будут отображаться и редактироваться в панели Component Inspector дизайнера экранов. Аннотация имеет следующие атрибуты:

* `name` - название атрибута, который будет сохраняться в XML. Если не установлено, то название будет определено по именованию setter-метода.
* `type` - тип свойства. Используется панелью Inspector, чтобы создать подходящий компонент ввода, предоставляющий подсказки и базовую валидацию. Описания всех типов свойств приведены <<component_metadata_property_types,здесь>>.
* `caption` - подпись свойства, отображается в панели Inspector.
* `description` - дополнительное описание свойства, отображается в панели Inspector как всплывающая подсказка по наведению мыши.
* `category` - категория свойства в панели Inspector (на данный момент еще не используется дизайнером экранов).
* `required` - обязательность свойства. Если свойство обязательное, то панель Inspector не позволит ввести для него пустое значение.
* `defaultValue` - значение свойства по умолчанию, т.е. значение, которое неявно используется действием, если соответствующий XML атрибут отсутствует. Значение по умолчанию не будет записываться в XML.
* `options` - список вариантов для свойства действия, например для типа свойства `ENUMERATION`.

Заметьте, что для свойств действий поддерживается только ограниченный набор Java типов:

* Примитивные типы: `String`, `Boolean`, `Byte`, `Short`, `Integer`, `Long`, `Float`, `Double`.
* Перечисления.
* `java.lang.Class`.
* `java.util.List` - список, состоящий из элементов, чьи типы указаны выше. Панель Inspector не имеет точно подходящего компонента для этого Java класса, поэтому этот тип должен вводиться как обычная строка, и помечаться как `PropertyType.STRING`.

Примеры:
[source, java]
----
include::{sourcesdir}/gui/std_actions/ActionPropertyExamples.java[]
----
<1> - строковое свойство с ограниченным набором вариантов ввода и значением по умолчанию.
<2> - обязательное свойство с набором вариантов - списком классов экранов, определенных в проекте.
<3> - список целых чисел. Тип свойства установлен как `STRING`, т.к. панель Inspector не содержит подходящего компонента ввода.

Также Studio предоставляет поддержку для событий и делегирующих методов в собственных действиях - такую же, как и для встроенных UI компонентов. Для объявления слушателя события или делегирующего метода в классе действия не требуется никаких дополнительных аннотаций. Пример их объявления приведен ниже.
--

[[custom_action_types_example]]
Пример настраиваемого действия: SendByEmailAction::
--
Этот пример демонстрирует:

* объявление и аннотирование класса собственного действия.
* аннотирование редактируемых параметров действия.
* объявление собственного класса события, производимого действием, и его обработчика.
* объявление делегирующих методов.

Действие `SendByEmailAction` реализует посылку email о сущности, выбранной в таблице, которой принадлежит действие. Это действие реализовано как полностью конфигурируемое, большая часть его внутренней логики может быть изменена с помощью редактируемых свойств, делегирующих методов и событий.

Исходный код действия:
[source, java]
----
include::{sourcesdir}/gui/std_actions/ActionWithParameters.java[]
----
<1> - класс действия помечен аннотацией `@StudioAction`.
<2> - id действия устанавливается аннотацией `@ActionType`.
<3> - класс действия параметризован типом `E` - это тип сущности, которая отображается компонентом таблицы.
<4> - адрес получателя email выставлен как редактируемое свойство действия.
<5> - метод, регистрирующий слушатель для события `EmailSentEvent`. Этот метод определяется Studio как объявление обработчика события в действии.
<6> - метод, устанавливающий объект `Function`, этот объект используется для делегирования (контроллеру экрана) логики составления тела письма. Этот метод определяется Studio как объявление делегирующего метода.
<7> - объявление другого делегирующего метода - на этот раз он используется для делегирования логики создания вложений к письму. Заметьте, что оба делегирующих метода используют параметр `E` генерик-типа.
<8> - обязательный делегирующий метод (реализованный в контроллере экрана) вызывается для составления текста письма.
<9> - если установлен, необязательный делегирующий метод вызывается для генерации вложений к письму.
<10> - здесь собственно и посылается email.
<11> - событие `EmailSentEvent` публикуется после успешной посылки письма. Если контроллер экрана был подписан на это событие, то будет вызван соответствующий обработчик.
<12> - объявление класса события. Обратите внимание, что в класс события можно добавить поля и таким образом передавать в логику обработки события дополнительные данные.

Если реализовать класс как показано выше, то Studio отобразит новое собственное действие вместе со стандартными действиями в диалоге создания действия:

image::gui_action/custom_action_wizard.png[align="center"]

Когда действие добавлено в дескриптор экрана, вы можете выбрать его и редактировать его свойства в панели Component Inspector:

image::gui_action/custom_action_properties.png[align="center"]

Когда свойство собственного действия изменяется в панели Inspector, оно записывается в дескриптор экрана следующим образом:

[source, xml]
----
include::{sourcesdir}/gui/std_actions/action_with_parameters.xml[]
----

Обработчики событий и делегирующие методы действия также отображаются и доступны для генерации в панели Component Inspector:

image::gui_action/custom_action_handlers.png[align="center"]

Пример сгенерированной логики с реализованными обработчиками события и делегирующими методами выглядит следующим образом:
[source, java]
----
include::{sourcesdir}/gui/std_actions/ActionWithParametersController.java[]
----
<1> - при инжекции действия используется корректный параметр типа.
<2> - реализация обработчика события.
<3> - реализация делегирующего метода `bodyGenerator`. Параметр типа `Customer` подставлен в сигнатуру метода.
<4> - реализация делегирующего метода `attachmentProvider`.
--
